# Backend API — Tài liệu tóm tắt

Tài liệu này mô tả API liên quan đến **household (hộ gia đình)** mà backend hiện đang cung cấp trong repository này.

**Base route:** `/api/house-hold`

**Lưu ý quan trọng:** Các controller yêu cầu thông tin user đã xác thực trong `req.user`.
Một số thao tác đọc `req.user.identification` và `req.user._id`.
Frontend cần đảm bảo middleware xác thực cung cấp thông tin người dùng (VD: qua token đã xác minh).

---

## Tóm tắt Schema (HouseHold)

- **namehousehold** (String, bắt buộc) — tên hộ gia đình
- **address** (String, bắt buộc)
- **namehead** (String, bắt buộc) — tên chủ hộ (backend tự đặt từ user hiện tại)
- **identification_head** (String, bắt buộc) — số định danh của chủ hộ (backend tự đặt từ user hiện tại)
- **members** (Array) — danh sách thành viên:
  `{ identification: String, name: String, relationship: String }`

**Lưu ý:** `identification_head` được đánh index unique — mỗi số định danh chủ hộ chỉ thuộc **1 hộ gia đình**.

---

## Các Endpoint (tóm tắt + ví dụ)

### 1. Tạo hộ gia đình

- **Method:** POST

- **Path:** `/api/house-hold/create-household`

- **Auth:** bắt buộc (dựa vào `req.user.identification`)

- **Headers:**

  - Content-Type: application/json
  - Authorization: Bearer `<token>`

- **Body (JSON):**

```json
{
  "name": "Nguyen Family",
  "address": "123 Le Loi, HCM",
  "members": [
    { "identification": "ID002", "name": "Nguyen Van B", "relationship": "con" }
  ]
}
```

- **Success (201):** trả về object household đã tạo

```json
{
  "_id": "<household-id>",
  "namehousehold": "Nguyen Family",
  "address": "123 Le Loi, HCM",
  "namehead": "Nguyen Van A",
  "identification_head": "ID001",
  "members": [
    {
      "identification": "ID002",
      "name": "Nguyen Van B",
      "relationship": "con",
      "_id": "..."
    }
  ],
  "__v": 0
}
```

- **Errors:**

  - 400 — tên hộ trùng, `members` không phải mảng, user đã thuộc hộ khác
  - 404 — user không tồn tại
  - 500 — lỗi server

**Lưu ý frontend:** chỉ cần gửi `name`, `address`, `members`; backend tự gán chủ hộ từ `req.user`.

---

### 2. Cập nhật hộ gia đình

- **Method:** PATCH

- **Path:** `/api/house-hold/update-household`

- **Auth:** bắt buộc (`req.user._id`)

- **Body:** có thể gửi bất kỳ field nào để cập nhật:

```json
{
  "name": "Tên mới",
  "address": "Địa chỉ mới",
  "members": [ ... ]
}
```

- **Success (200):** trả về household đã cập nhật
- **Errors:**

  - 404 — user không thuộc hộ nào
  - 403 — chỉ **chủ hộ** (user.name == namehead) mới được cập nhật
  - 400 — `members` không phải array

---

### 3. Đọc hộ gia đình theo số định danh chủ hộ

- **Method:** GET

- **Path:** `/api/house-hold/read-household/:identification_head`

- **Params:** `identification_head` — string

- **Success (200):** trả về household

- **Errors:**

  - 404 — không tìm thấy hộ

---

### 4. Additional endpoints (now exposed)

- **getAllHouseHolds** — GET `/api/house-hold/all-households` — optionally paginated via ?page=N (50 items per page)

- **deleteHouseHold** — DELETE `/api/house-hold/delete-household` — only the head of household can delete their household

---

## Ví dụ cURL

### Tạo household (cần token)

```sh
curl -X POST "http://localhost:5000/api/house-hold/create-household" \
 -H "Content-Type: application/json" \
 -H "Authorization: Bearer <token>" \
 -d '{ "name": "Nguyen Family", "address": "123 Le Loi, HCM", "members": [{ "identification": "ID002", "name": "Nguyen Van B", "relationship": "con" }] }'
```

### Đọc household theo identification_head

```sh
curl -X GET "http://localhost:5000/api/house-hold/read-household/ID001"
```

### Cập nhật household (cần token)

```sh
curl -X PATCH "http://localhost:5000/api/house-hold/update-household" \
 -H "Content-Type: application/json" \
 -H "Authorization: Bearer <token>" \
 -d '{ "name": "Nguyen Family Updated", "address": "456 Nguyen Hue" }'
```

### Lấy danh sách toàn bộ households (paginated)

```sh
curl -X GET "http://localhost:5000/api/house-hold/all-households?page=1"
```

### Xoá household (cần token - chỉ chủ hộ)

```sh
curl -X DELETE "http://localhost:5000/api/house-hold/delete-household" \
 -H "Authorization: Bearer <token>"
```

---

## Checklist nhanh cho Frontend

- Luôn gửi auth token cho các route create/update.
- Đảm bảo middleware backend set `req.user` (có identification và `_id`).
- Gửi `members` đúng định dạng array object.
- `identification_head` là unique — 1 người chỉ làm chủ 1 hộ.

---

## Ghi chú về user & id

- Model `User` dùng `_id: String` làm khóa chính, và có virtual `identification` trỏ về `_id`.
- Khi tạo user mới cần set `_id` hoặc `identification` rõ ràng.
- Nếu trước đó có dùng ObjectId, có thể cần migration khi chuyển sang ID dạng string.

---

## Thêm sửa thông tin cho user:<version mới nhất>

- URL: http://localhost:5000/api/user/update-profile

- input: {
  "identification": "001234567890",
  "phone": "0922222222",
  "currentPassword": "123456",
  "newPassword": "newpass789"
  }

- output: {
  "message": "Profile updated successfully",
  "user": {
  "\_id": "6950e95b17ab2eb56dc1ca10",
  "identification": "001234567890",
  "name": "Nguyễn Văn Test",
  "phone": "0922222222",
  "address": "123 Đường Test, Hà Nội",
  "dob": "1995-01-15T00:00:00.000Z"
  }
  }

## Thêm thành viên

- URL:http://localhost:5000/api/house-hold/add-member

- input:{
  "houseHoldId": "68efc1195ffbd315ee8eccf4",
  "newMemberId": "694ebc246c99312e570a4abd",
  "relationship": "Con",
  "identification": "123456789012",
  "name": "Nguyễn Văn A"
  }

- output:
  {
  "message": "Member added successfully",
  "household": {
  "id": "68efc1195ffbd315ee8eccf4",
  "identification_head": "ID3001"
  },
  "newMember": {
  "id": "694ebc246c99312e570a4abd",
  "name": "Nguyễn Văn A",
  "relationship": "Con",
  "identification": "123456789012"
  }
  }
